---
import { getAllJobs } from '../../lib/supabase';
import Layout from '../../layouts/Layout.astro';
import { SITE_TITLE } from '../../consts';
import { isValidLocation } from '../../lib/utils';

export async function getStaticPaths() {
  const allJobs = await getAllJobs();
  const locationsWithJobs = new Set<string>();

  allJobs.forEach(job => {
    job.job_locations.forEach(loc => {
      if (isValidLocation(loc.location)) {
        locationsWithJobs.add(loc.location);
      }
    });
  });

  return Array.from(locationsWithJobs).map(loc => ({ 
    params: { location: loc.toLowerCase().replace(/\s+/g, '-') } 
  }));
}

const { location } = Astro.params;
const locationParam = typeof location === 'string' ? location : '';
const decodedLocation = locationParam
  .split('-')
  .map(w => w.charAt(0).toUpperCase() + w.slice(1))
  .join(' ');

const jobs = (await getAllJobs()).filter(job => 
  job.job_locations.some(l => 
    l.location.toLowerCase().replace(/\s+/g, '-') === locationParam.toLowerCase()
  )
);
---
<Layout
  title={`Jobs in ${decodedLocation} | ${SITE_TITLE}`}
  description={`Browse civil service jobs in ${decodedLocation}. Find opportunities by department, salary, and more.`}
>
  <div class="container">
    <h1 class="text-4xl font-bold text-brand-primary mb-4">Civil Service Jobs in {decodedLocation}</h1>
    <p class="text-lg text-text-secondary mb-8">
      Discover a range of public sector and government careers right here in {decodedLocation}. Whether you're seeking roles in administration, policy, or operations, you can find local opportunities that make a difference. Browse the latest Civil Service jobs in {decodedLocation} below.
    </p>
    {jobs.length === 0 ? (
      <p class="text-lg text-text-secondary">No jobs found in {decodedLocation}.</p>
    ) : (
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {jobs.map(job => (
          <div class="bg-white p-6 rounded-lg border border-border-color shadow-sm hover:shadow-md transition-shadow">
            <h2 class="text-xl font-bold text-brand-primary">
              <a href={job.url} class="hover:underline" target="_blank" rel="noopener noreferrer">
                {job.title}
              </a>
            </h2>
            <p class="text-text-secondary mt-2">Department: {job.department}</p>
            <p class="text-text-secondary">Salary: {job.salary}</p>
            <p class="text-text-secondary">Locations: {job.job_locations.map(l => l.location).join(', ')}</p>
            <p class="text-text-secondary">Closes: {job.closing_date ? new Date(job.closing_date).toLocaleDateString() : 'N/A'}</p>
          </div>
        ))}
      </div>
    )}
  </div>
</Layout>