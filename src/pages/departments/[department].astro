---
import { getAllJobs, getUniqueValues } from '../../lib/supabase';
import Layout from '../../layouts/Layout.astro';
import { SITE_TITLE } from '../../consts';
import JobList from '../../components/JobList.astro';

export async function getStaticPaths() {
  const uniqueDepartments = await getUniqueValues('job_listings', 'department');
  console.log('Generated departments:', uniqueDepartments);
  return uniqueDepartments.map((dep: string) => ({
    params: { department: dep.toLowerCase().replace(/\s+/g, '-') },
  }));
}

const { department } = Astro.params;
const departmentParam = typeof department === 'string' ? department : '';
const decodedDepartment = departmentParam
  .split('-')
  .map(w => w.charAt(0).toUpperCase() + w.slice(1))
  .join(' ');
const jobs = (await getAllJobs()).filter(job =>
  job.department &&
  job.department.toLowerCase().replace(/\s+/g, '-') === departmentParam.toLowerCase()
);
console.log(`Jobs for ${decodedDepartment}:`, jobs);
---
<Layout
  title={`Jobs in ${decodedDepartment} | ${SITE_TITLE}`}
  description={`Browse civil service jobs in the ${decodedDepartment} department. Find opportunities by location, salary, and more.`}
>
  <div class="container">
    <h1 class="text-4xl font-bold text-brand-primary mb-4">Jobs in {decodedDepartment}</h1>
    <JobList jobs={jobs} />
  </div>
</Layout>